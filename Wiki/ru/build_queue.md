# Обзор #

В игре есть глобальная очередь событий (queue), в которой хранится текущая постройка/снос на планете.
Тип события - Build, для постройки, Demolish - для сноса.
Более подробно тут : EngineTaskQueue

Когда у пользователя активен Командир, то у него появляется возможность "складывать" новые постройки в дополнительную специальную очередь - очередь построек (build queue или по немецки bauliste).

# Детали #

Формат таблицы очереди построек **buildqueue**:

| **столбец** | **SQL тип** | **описание** |
|:-------------------|:---------------|:---------------------|
| id| INT AUTO\_INCREMENT PRIMARY KEY| Порядковый номер, начинается с 1|
| owner\_id | INT  | ID пользователя |
| planet\_id | INT  | ID планеты |
| list\_id | INT | порядковый номер внутри очереди |
| tech\_id | INT | ID постройки |
| level | INT | целевой уровень |
| destroy | INT | 1 - снести, 0 - построить |
| start | INT UNSIGNED | время запуска постройки |
| end | INT UNSIGNED | время окончания строительства |

У каждой планеты своя очередь построек. Постройки строятся по порядку, в зависимости от list\_id.

# Строительство построек в обычном режиме #

URL для постройки: http://uni20.ogame.de/game/index.php?page=b_building&session=cbfc8ad862b5&modus=add&techid=1&planet=1281073
URL для сноса: http://uni20.ogame.de/game/index.php?page=b_building&session=cbfc8ad862b5&techid=1&modus=destroy&planet=1281073

techid : ID постройки<br>
planet : ID планеты<br>
<br>
<h2>Постройка</h2>

<ul><li>Проверяется возможность строительства постройки<br>
</li><li>Списываются ресурсы, равные стоимости постройки<br>
</li><li>В глобальную очередь queue помещается задание типа Build, start = текущему моменту времени, end = start + длительность постройки<br>
</li><li>В очередь построек добавляется первая постройка (list_id=1)</li></ul>

<h2>Снос</h2>

<ul><li>То же самое что и постройка, только тип задания Demolish</li></ul>

<h2>Отмена</h2>

<ul><li>Возвращаются ресурсы<br>
</li><li>Из очереди queue удаляется событие<br>
</li><li>Из очереди построек удаляется запись</li></ul>

<h2>Завершение постройки/сноса</h2>

<ul><li>Корректируется уровень постройки<br>
</li><li>Корректируется количество полей на планете<br>
</li><li>Пересчитывается статистика<br>
</li><li>Из очереди queue удаляется событие<br>
</li><li>Из очереди построек удаляется запись</li></ul>

Таким образом строительство построек без очереди можно представить себе как строительство с очередью, но только длина очереди равна 1.<br>
<br>
<h1>Строительство построек с очередью</h1>

<h2>Добавление первой постройки</h2>

<ul><li>Аналогично обычному режиму</li></ul>

<h2>Добавление последующей (складывание в очередь)</h2>

<ul><li>Если в очереди построек уже есть 5 заданий (с текущим), то ничего не делаем<br>
</li><li>list_id увеличивается на 1<br>
</li><li>В очередь построек добавляется новая запись</li></ul>

<h2>Отмена текущей постройки</h2>

<ul><li>Аналогично обычному режиму, но дополнительно делаются следующие шаги:<br>
</li><li>Перебираем очередь построек :<br>
</li><li>Проверяется возможность строительства постройки N. Если строительство невозможно, то выводим сообщение и переходим на след. шаг<br>
</li><li>Списываются ресурсы, равные стоимости постройки N<br>
</li><li>В глобальную очередь queue помещается задание, start = время завершения/отмены предыдущей постройки, end = start + длительность постройки</li></ul>

<h2>Отмена последующей</h2>

<ul><li>Удаляется запись в очереди построек<br>
</li><li>Перебираются все последующие постройки и у построек такого же типа, как удаленная - текущий уровень уменьшается на 1</li></ul>

<h2>Завершение текущей постройки</h2>

<ul><li>Аналогично обычному режиму, но дополнительно делаются шаги как и у отмены текущей постройки.</li></ul>

<h1>Удаление планеты</h1>

После того, как обычная планета становится "Уничтоженной" - очередь её построек удаляется.<br>
<br>
После уничтожения луны звездой смерти - очередь построек также удаляется.<br>
<br>
После удаления давно неактивного игрока, или аккаунта поставленного на удаления - очереди построек всех планет также удаляются.