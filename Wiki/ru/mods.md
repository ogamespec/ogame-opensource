# Драфт по модификациям

Первоначальный эксперимент с хардкодом в базовые исходники получился не очень. Всё это вышло кастомно и костыльно, исходники загрязняются, БД тоже.
В #159 все эксперименты по модификациям были выпилены, чтобы добавить более продуманную реализацию. В этой заметке будет собираться всё что связано с новой реализацией модов - задумки, описание и проч.

## Папка с модами

Все моды хранятся как суб-директории в `/game/mods`. Папка с модификацией является самодостаточной: содержит весь код и ресурсы для поддержания модификации.

## Базовая часть

Базой является основной движок версии 0.84. Все модификации расширяют или изменяют именно 0.84.

## Установка модов

Моды активируются через раздел админки (`pages_admin/admin_mods.php`). Админ может включить и отключить мод, а также задать очередность их "активации". Проброс в моды происходит в очередности их активации.

## Влияние модификаций

Модификации влияют на базовую часть следующим образом:
- При активации мода добавляются новые колонки в таблицы игры или даже новые таблицы. Все новые колонки добавляются в конец оригинальных таблиц. При деактивации мода - колонки и таблицы удаляются.
- Новые картинки css и javascript содержатся в папке мода. Скины никаким образом не связаны с модами, т.к. меняют только базовую часть игры
- Конструктор мода. Перед переходом на обработчик страницы - управление передаётся на конструктор мода (`ctor`), который модифицирует таблицы из базовой части (например таблицу стоимости). Список изменямых таблиц игры будет далее.
- Модификация может как добавлять свои страницы в игру, так и менять старые. В этом месте нужно будет отделить бекенд страницы от фронтенда. Бекенд сделать на json, чтобы моды могли модифицировать контент, а фронтенд просто рендерит то что породила базовая часть и моды. Пример: пункты левого меню; строки таблицы в меню Сырьё.
- Боевой движок сейчас делается модо-независимым, все входные таблицы для расчётов будут передаваться через фронтенд боевого движка.
- Алгоритмическая часть - содержит callbacks для проброса в моды, чтобы менялось поведение базовых алгоритмов (напр. что делать после боя)
- Новые задания для очереди событий. Моды могут реализовать свои события, обработчики находятся в модах.
- Модам доступна вся базовая модель игры (planet.php, user.php и проч. базовые модули)