# Драфт по модификациям

Первоначальный эксперимент с хардкодом в базовые исходники получился не очень. Всё это вышло кастомно и костыльно, исходники загрязняются, БД тоже.
В #159 все эксперименты по модификациям были выпилены, чтобы добавить более продуманную реализацию. В этой заметке будет собираться всё что связано с новой реализацией модов - задумки, описание и проч.

## Папка с модами

Все моды хранятся как суб-директории в `/game/mods`. Папка с модификацией является самодостаточной: содержит весь код и ресурсы для поддержания модификации.

## Базовая часть

Базой является основной движок версии 0.84. Все модификации расширяют или изменяют именно 0.84.

## Установка модов

Моды активируются через раздел админки (`pages_admin/admin_mods.php`). Админ может включить и отключить мод, а также задать очередность их "активации". Проброс в моды происходит в очередности их активации.

## Влияние модификаций

Модификации влияют на базовую часть следующим образом:
- При активации мода добавляются новые колонки в таблицы игры или даже новые таблицы. Все новые колонки добавляются в конец оригинальных таблиц. При деактивации мода - колонки и таблицы удаляются. Можно использовать install.sql / uninstall.sql из мода для этих целей
- Новые картинки css и javascript содержатся в папке мода. Скины никаким образом не связаны с модами, т.к. меняют только базовую часть игры
- Конструктор мода. Перед переходом на обработчик страницы - управление передаётся на конструктор мода (`ctor`), который модифицирует таблицы из базовой части (например таблицу стоимости). Список изменямых таблиц игры будет далее.
- Модификация может как добавлять свои страницы в игру, так и менять старые. В этом месте нужно будет отделить бекенд страницы от фронтенда. Бекенд сделать на json, чтобы моды могли модифицировать контент, а фронтенд просто рендерит то что породила базовая часть и моды. Пример: пункты левого меню; строки таблицы в меню Сырьё. Такой подход называется JSON-first.
- Боевой движок сейчас делается модо-независимым, все входные таблицы для расчётов будут передаваться через фронтенд боевого движка.
- Алгоритмическая часть - содержит hooks для проброса в моды, чтобы менялось поведение базовых алгоритмов (напр. что делать после боя)
- Новые задания для очереди событий. Моды могут реализовать свои события, обработчики находятся в модах.
- Модам доступна вся базовая модель игры (planet.php, user.php и проч. базовые модули)

## manifest.json

Содержит базовое описание модификации, типа:

```json
{
  "name": "My Awesome Mod",
  "version": "1.0.0",
  "author": "YourName",
  "description": "Добавляет новые возможности для игроков",
  "website": "https://github.com/yourname/mod-name"
}
```

## Модуль поддержки модификаций

Находится в `mods.php`. Список методов:
- ModsInit: инициализировать подсистему модификаций. Выполняется в самом начале работы движка. Вызывается метод `init` мода.
- ModsExec: выполнить хук из разных мест базового движка. Список хуков находится в интерфейсе `GameMod`. Хук выполняется для всех модов в порядке активации. Вызов сделан таким образом, что можно передавать переменное количество параметров.
- ModsExecRef: вариант ModsExec с параметром ссылкой
- ModsExecRefArr: вариант ModsExec с параметрами ссылка + массив
- ModsList: получить список активных модификаций и доступных (неактивных). Вызывается из админки
- ModsGetInfo: получить информацию о модификации (парсит метаданные). Вызывается из админки
- ModsInstall: активировать (инсталлировать) мод. Вызывается из админки. Вызывается метод `install` мода.
- ModsRemove: деактивировать (деинсталлировать) мод. Вызывается из админки. Вызывается метод `uninstall` мода.
- ModsMoveUp: повысить приоритет активации мода. Вызывается из админки
- ModsMoveDown: понизить приоритет активации мода. Вызывается из админки

## Главный модуль мода

Все основные методы реализации мода находятся в модуле `main.php`; Данные модуль реализует интерфейс `GameMod`.

## Как хранится список активных модов

Список хранится в колонке `modlist` таблицы `uni`, список через `;` в порядке активации мода (первым активируется тот что левее ("выше")).

## Админка

![admin_mods](/imgstore/admin_mods.png)

В целом ничего сложного:
- Слева находится список активированных модификаций и кнопки управления приоритетом и "удаления" (деактивации) мода
- Справа находится список имеющихся модификаций, которые находятся в папке `game/mods`

Техзадание для нейросети, с помощью котрого был получен вайб-код (уточнения делались руками):

```
Нужно добавить в админку панель управления модами.
Будет таблица из двух колонок - слева активные моды, справа доступные. У колонки должен быть заголовок ("Активные", "Доступно").
Каждый мод - это панель с картинкой заднего плана (600x200). Поверх картинки текст через строку из манифеста:
- Заголовок (название мода)
- Описание
- Версия
- Автор
- Ссылка на вебсайт
Для активных модов нужно добавить GET ссылки - "Выше", "Ниже" и "Удалить" (под основным текстом справа)
Для доступных модов нужно добавить ссылку GET - "Установить" (под основным текстом справа)

мета:
{
  "name": "Demo Modification",
  "version": "1.0.0",
  "author": "ogamespec",
  "description": "A simple modification to demonstrate the capabilities",
  "website": "https://github.com/ogamespec/ogame-opensource"
}

Дай пример html кода для реализации данной панели управления. Можешь использовать стили из приложенных файлов (default.css, formate.css)
```

Было решено в целях украшения также добавить картинку заднего фона для панели мода (находится в `img/bg.png`)

## Хуки

Из разных мест игры вызываются хуки, с помощью которых модификация может менять поведение базового движка игры.

### Хук обработчика событий (update_queue)

Вызывается при завершении любого события, чтобы мод мог обработать свои кастомные события.
Находится в queue.php, вызывается в default секции, если ни один базовый тип задания не подходит:
```php
            default:
                $res = ModsExec ('update_queue', [$queue]);
                if (!$res) {
                    RemoveQueue ( $queue['task_id'] );
                    Debug ( loca_lang("DEBUG_QUEUE_UNKNOWN", $GlobalUni['lang']) . $queue['type']);
                }
                break;
```

### Хук для отрисовки ресурсов (add_resources)

Вызывается из page.php. Принимает ссылку на массив итемов (изначально там только дефолтные типы ресурсов Металл, Кристалл итд.). Второй параметр - текущая активная планета (чтобы модификация могла брать ресурсы и оттуда). Ресурсы аккаунта можно брать из глобальной `$GlobalUser`.

```php
ModsExecRefArr ('add_resources', $json, $aktplanet);
```