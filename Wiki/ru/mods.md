# Драфт по модификациям

Первоначальный эксперимент с хардкодом в базовые исходники получился не очень. Всё это вышло кастомно и костыльно, исходники загрязняются, БД тоже.
В #159 все эксперименты по модификациям были выпилены, чтобы добавить более продуманную реализацию. В этой заметке будет собираться всё что связано с новой реализацией модов - задумки, описание и проч.

## Папка с модами

Все моды хранятся как суб-директории в `/game/mods`. Папка с модификацией является самодостаточной: содержит весь код и ресурсы для поддержания модификации.

## Базовая часть

Базой является основной движок версии 0.84. Все модификации расширяют или изменяют именно 0.84.

## Установка модов

Моды активируются через раздел админки (`pages_admin/admin_mods.php`). Админ может включить и отключить мод, а также задать очередность их "активации". Проброс в моды происходит в очередности их активации.

## Влияние модификаций

Модификации влияют на базовую часть следующим образом:
- При активации мода добавляются новые колонки в таблицы игры или даже новые таблицы. Все новые колонки добавляются в конец оригинальных таблиц. При деактивации мода - колонки и таблицы удаляются. Можно использовать install.sql / uninstall.sql из мода для этих целей
- Новые картинки css и javascript содержатся в папке мода. Скины никаким образом не связаны с модами, т.к. меняют только базовую часть игры
- Конструктор мода. Перед переходом на обработчик страницы - управление передаётся на конструктор мода (`init`), который модифицирует таблицы из базовой части (например таблицу стоимости). Список изменямых таблиц игры будет далее.
- Модификация может как добавлять свои страницы в игру, так и менять старые. В этом месте нужно будет отделить бекенд страницы от фронтенда. Бекенд сделать на json, чтобы моды могли модифицировать контент, а фронтенд просто рендерит то что породила базовая часть и моды. Пример: пункты левого меню; строки таблицы в меню Сырьё. Такой подход называется JSON-first.
- Боевой движок сейчас делается модо-независимым, все входные таблицы для расчётов будут передаваться через фронтенд боевого движка.
- Алгоритмическая часть - содержит hooks для проброса в моды, чтобы менялось поведение базовых алгоритмов (напр. что делать после боя)
- Новые задания для очереди событий. Моды могут реализовать свои события, обработчики находятся в модах.
- Модам доступна вся базовая модель игры (planet.php, user.php и проч. базовые модули)

## manifest.json

Содержит базовое описание модификации, типа:

```json
{
  "name": "My Awesome Mod",
  "version": "1.0.0",
  "author": "YourName",
  "description": "Добавляет новые возможности для игроков",
  "website": "https://github.com/yourname/mod-name"
}
```

## Модуль поддержки модификаций

Находится в `mods.php`. Список методов:
- ModsInit: инициализировать подсистему модификаций. Выполняется в самом начале работы движка. Вызывается метод `init` мода ("конструктор").
- ModsExec: выполнить хук из разных мест базового движка. Список хуков находится в классе `GameMod`. Хук выполняется для всех модов в порядке активации. Вызов без параметров.
- ModsExecRef: вариант ModsExec с параметром ссылкой
- ModsExecRefArr: вариант ModsExec с параметрами ссылка + массив
- ModsExecRefRef: вариант ModsExec с параметрами ссылка + ссылка
- ModsExecRefStr: вариант ModsExec с параметрами ссылка + строка
- ModsList: получить список активных модификаций и доступных (неактивных). Вызывается из админки
- ModsGetInfo: получить информацию о модификации (парсит метаданные). Вызывается из админки
- ModsInstall: активировать (инсталлировать) мод. Вызывается из админки. Вызывается метод `install` мода.
- ModsRemove: деактивировать (деинсталлировать) мод. Вызывается из админки. Вызывается метод `uninstall` мода.
- ModsMoveUp: повысить приоритет активации мода. Вызывается из админки
- ModsMoveDown: понизить приоритет активации мода. Вызывается из админки

## Главный модуль мода

Все основные методы реализации мода находятся в модуле `main.php`; Данный модуль реализует класс `GameMod`. Не обязательно реализовывать все методы классы, неиспользуемые можно не определять.

## Как хранится список активных модов

Список хранится в колонке `modlist` таблицы `uni`, список через `;` в порядке активации мода (первым активируется тот что левее ("выше")).

## Админка

![admin_mods](/imgstore/admin_mods.png)

В целом ничего сложного:
- Слева находится список активированных модификаций и кнопки управления приоритетом и "удаления" (деактивации) мода
- Справа находится список имеющихся модификаций, которые находятся в папке `game/mods`

Техзадание для нейросети, с помощью котрого был получен вайб-код (уточнения делались руками):

```
Нужно добавить в админку панель управления модами.
Будет таблица из двух колонок - слева активные моды, справа доступные. У колонки должен быть заголовок ("Активные", "Доступно").
Каждый мод - это панель с картинкой заднего плана (600x200). Поверх картинки текст через строку из манифеста:
- Заголовок (название мода)
- Описание
- Версия
- Автор
- Ссылка на вебсайт
Для активных модов нужно добавить GET ссылки - "Выше", "Ниже" и "Удалить" (под основным текстом справа)
Для доступных модов нужно добавить ссылку GET - "Установить" (под основным текстом справа)

мета:
{
  "name": "Demo Modification",
  "version": "1.0.0",
  "author": "ogamespec",
  "description": "A simple modification to demonstrate the capabilities",
  "website": "https://github.com/ogamespec/ogame-opensource"
}

Дай пример html кода для реализации данной панели управления. Можешь использовать стили из приложенных файлов (default.css, formate.css)
```

Было решено в целях украшения также добавить картинку заднего фона для панели мода (находится в `img/bg.png`)

## Глобальные переменные

Модам доступны глобальные переменные игры. Например, мод может поменять характериситики юнитов. Список глобальных переменных, которые обычно хочет мод:
- buildmap: список ID построек
- resmap: список ID исследований
- fleetmap: список ID флота
- defmap: список ID обороны
- rakmap: список ID ракет (специальный тип обороны, которую можно строить в ракетной шахте)
- resourcemap: список ID ресурсов игры (планетных, игрока, все подряд)
- scoreResources: список ID ресурсов, которые используются для подсчёта очков
- transportableResources: список ID ресурсов, которые можно перевозить флотом и захватывать при атаках
- initial: таблица начальной стоимости игровых объектов
- UnitParam: параметры флота и обороны (атака, броня и проч.)
- RapidFire: настройки скорострела
- requirements: требования для строительства (дерево технологий)
- CanBuildTab: какие постройки можно строить для указанного типа галактики (планета, луна и пр.)

## Какие игровые страницы может менять мод

Кроме изменения общих элементов управления (левое меню, панель ресурсов, панель бонусов с офицерами), мод может вмешиваться в контент некоторых игровых страниц:
- b_building, buildings: Если мод добавляет какие-то новые постройки или исследования для объекта галактики, то на этих страницах может появляться новый контент для строительства/улучшения новых построек или исследований
- flotten1: модификация может добавить новые команды для флота (новые кнопки)
- flotten2: добавляется возможность выбрать новые типы кораблей для отправки на задание
- flotten3: добавляются новые задания, новые ресурсы для загрузки, ещё какие-то опции для отправки флота
- galaxy: новые типы объектов галактики могут отображаться особенным образом (например астероиды, космические станции)
- imperium: отображаются новые типы объектов, новые типы построек или исследований
- infos: информация о новых игровых объектах (новые корабли, постройки, что-то ещё); дополнительные действия с объектом
- options: мод может добавить какие-то дополнительные настройки
- overview: свойства объекта галактики можно расширить новыми параметрами; можно добавить дополнительный контент перед списком событий
- events: код списка событий будет сделан общим для Обзора и Фаланги. Модификации смогут добавлять новые типы событий и заданий флота в него
- resources: Если на планете (объекте) есть какое-то производство - оно унифицированно выводится в этом меню (настраивается количество строк и управление выработкой)
- sprungtor: можно выбрать новые типы флота для прыжка
- statistics: мод может добавить новую категорию для статистики, наряду со стандартными (Очки/Флот/Исследования)
- techtree: дерево технологий должно учитывать новые игровые объекты и требования для них
- admin: Моды могут добавить новый пункт (панель) в админку

## Хуки

Из разных мест игры вызываются хуки, с помощью которых модификация может менять поведение базового движка игры.

В целом хуки устроены так, что на вход принимают параметры (входные и выходные), а возвращают `true` или `false`. Если нужно остановить выполнение хука для других модов в очереди нужно вернуть `true`, иначе нужно вернуть `false`, чтобы пробросить хук далее по списку.

### Обработка событий (update_queue)

Вызывается при завершении любого события, чтобы мод мог обработать свои кастомные события.
Находится в queue.php, вызывается в default секции, если ни один базовый тип задания не подходит:
```php
            default:
                $res = ModsExecRef ('update_queue', $queue);
                if (!$res) {
                    RemoveQueue ( $queue['task_id'] );
                    Debug ( loca_lang("DEBUG_QUEUE_UNKNOWN", $GlobalUni['lang']) . $queue['type']);
                }
                break;
```

### Отрисовка ресурсов (add_resources)

Вызывается из page.php. Принимает ссылку на массив итемов (изначально там только дефолтные типы ресурсов Металл, Кристалл итд.). Второй параметр - текущая активная планета (чтобы модификация могла брать ресурсы и оттуда). Ресурсы аккаунта можно брать из глобальной `$GlobalUser`.

```php
ModsExecRefArr ('add_resources', $json, $aktplanet);
```

### Изменение пунктов левого меню (add_menuitems)

Вызывается из page.php. На вход принимает json со структурой левого меню, в которое мод может добавить свои новые пункты.

### Блокировка таблиц (lock_tables)

Вызывается из модуля db.php в методе LockTables. Модификация может добавить свои таблицы, которые следует залочить.

### Обновление состава таблиц игры (install_tabs_included)

При сериализации БД игры (db.php, SerializeDB), а также в панели управления БД (`pages_admin/admin_db.php`) нужно дать моду модифицировать таблицу `$tabs`, где описывается структура игровых таблиц. Иначе сериализация и проверка БД не будет учитывать новые колонки, которые добавила модификация.

### Получение картинки объектов галактики (планет) (get_planet_small_image, get_planet_image)

Получение картинок объектов галактики (например планет) требуется для Обзора и Галактики. Если модификация добавляет свои объекты, необходимо вернуть путь для картинки этих объектов (установить параметр `$img['path']` и вернуть true). Тип объекта находится в `$planet['type']`.

### Получение картинки игровых объектов (get_object_image)

### Добавление своего контента в другие страницы (begin_content, end_content)

Модификация может добавить дополнительный контент в самое начало CONTENT AREA или после контента (в конец CONTENT AREA). Контент добавляется простым `echo`, страницу можно узнать также обычным образом (`$_GET['page']`).

### Добавление строки в таблицу БД (add_db_row)

Основной движок добавляет новую запись в какую-то таблицу только методом `AddDBRow` (db.php); Чтобы модификация смогла "докинуть" свои значения используется хук, который на вход принимает ссылку на массив добавляемой записи и имя таблицы.